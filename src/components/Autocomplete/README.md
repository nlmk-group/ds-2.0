# Autocomplete Component

## Версия компонента v3.2

Компонент Autocomplete используется для предоставления функции автозаполнения на основе введенного текста, позволяя пользователю выбирать из предложенных вариантов.

## Использование

```jsx
import { Autocomplete } from '@nlmk/ds-2.0';

/ Базовое использование
<Autocomplete
  items={[
    { id: 1, label: 'Первый', value: 'value_1' },
    { id: 2, label: 'Второй', value: 'value_2' }
  ]}
  nameGetter={({ label }) => label}
  onChange={item => console.log(item)}
/>;
/ С созданием нового элемента
<Autocomplete
  items={items}
  nameGetter={({ label }) => label}
  onChange={onChange}
  onCreateItem={value => console.log('Creating:', value)}
  createItemText={value => `Создать: ${value}`}
/>;
/ С подгрузкой данных
<Autocomplete
  items={items}
  nameGetter={({ label }) => label}
  onChange={onChange}
  isLoading={isLoading}
  onLoadMore={handleLoadMore}
  canLoadMore={hasMoreItems}
/>;
/ С кастомным текстом "Total" и задержкой debounce
<Autocomplete
  items={items}
  nameGetter={({ label }) => label}
  onChange={onChange}
  totalText="Найдено:"
  debounceDelay={1000}
/>;
```

## Props

| Prop | Type | Default | Description |
| --- | --- | --- | --- |
| selected | IAutocompleteValue | - | Изначально выбранный элемент |
| items | Array<IAutocompleteValue> \| null | [] | Массив элементов для автозаполнения |
| isLoading | boolean | false | Состояние загрузки данных |
| nameGetter | function | - | Функция для получения отображаемой строки |
| renderLabel | function | - | Кастомный рендер label для опций |
| onChange | function | - | Колбэк при выборе/очистке элемента |
| onFullItemSelect | function | - | Колбэк для получения полного объекта |
| onDebouncedInputChange | function | - | Колбэк после завершения ввода |
| disabled | boolean | false | Отключить ввод и выбор |
| helperText | string | '' | Сообщение об ошибке |
| error | boolean | false | Флаг состояния ошибки |
| showTooltip | boolean | false | Показывать tooltip при наведении |
| readOnly | boolean | false | Только для чтения |
| isFullWidth | boolean | false | Занимать полную ширину |
| withPortal | boolean | false | Рендерить через портал |
| size | EAutocompleteSize | 'm' | Размер компонента |
| canLoadMore | boolean | false | Можно ли загрузить больше данных |
| onLoadMore | function | - | Колбэк для догрузки данных |
| onCreateItem | function | - | Колбэк для создания нового элемента |
| noResultsText | string | 'Ничего не найдено' | Текст при отсутствии результатов |
| createItemText | function | (value) => `Добавить: ${value}` | Текст кнопки создания элемента |
| totalText | string | 'Всего:' | Текст для отображения общего количества |
| showTotalCount | boolean | true | Показывать ли общее количество элементов |
| debounceDelay | number | 500 | Задержка в мс для debounce при вводе |
| showEmptyDropdown | boolean | true | Показывать ли дропдаун при отсутствии результатов |
| helperText | string | '' | Вспомогательный текст под полем ввода |
| error | boolean | false | Флаг состояния ошибки (окрашивает компонент в красный цвет) |
| className | string | - | Дополнительный CSS класс |
| style | CSSProperties | - | Inline стили |

## Размеры (EAutocompleteSize)

- `xs` - экстра маленький (36px)
- `s` - маленький (40px)
- `m` - средний (48px, по умолчанию)

## Стилизация

Компонент можно кастомизировать несколькими способами:

### 1. CSS классы

Компонент использует CSS модули для стилизации. Основные классы:

```scss
.autocomplete {
  // Основной контейнер
}

.card {
  // Выпадающий список
  &-small {
    // Модификатор для маленького размера
  }

  &-extra-small {
    // Модификатор для экстра маленького размера
  }
}

.menu-item {
  // Элемент списка
}

.total {
  // Счетчик результатов
}

.not-found-item {
  // Блок "не найдено"
}

.icon-disabled {
  // Стили для отключенной иконки
}
```

Вы можете переопределить эти стили, передав собственный `className`.

### 2. Data-атрибуты

Для удобной кастомизации компонент предоставляет следующие data-атрибуты:

```css
/* Основной контейнер */
[data-ui-autocomplete] {
  /* стили */
}

/* Поле ввода */
[data-ui-autocomplete-input] {
  /* стили */
}

/* Контейнер иконок */
[data-ui-autocomplete-icons] {
  /* стили */
}

/* Кнопка очистки */
[data-ui-autocomplete-clear] {
  /* стили */
}

/* Иконка поиска */
[data-ui-autocomplete-search] {
  /* стили */
}

/* Выпадающий список */
[data-ui-autocomplete-dropdown] {
  /* стили */
}

/* Контейнер пустого состояния */
[data-ui-autocomplete-empty] {
  /* стили */
}

/* Элемент создания нового пункта */
[data-ui-autocomplete-create-item] {
  /* стили */
}

/* Сообщение об отсутствии результатов */
[data-ui-autocomplete-no-results] {
  /* стили */
}

/* Контейнер с результатами */
[data-ui-autocomplete-content] {
  /* стили */
}

/* Счетчик результатов */
[data-ui-autocomplete-total] {
  /* стили */
}

/* Элемент списка */
[data-ui-autocomplete-item] {
  /* стили */
}

/* Состояние загрузки */
[data-ui-autocomplete-loading] {
  /* стили */
}
```

### 3. Inline стили

Можно передать объект стилей через проп `style`:

```jsx
<Autocomplete
  style={{ maxWidth: '300px', marginBottom: '16px' }}
  items={items}
  nameGetter={({ label }) => label}
  onChange={onChange}
/>
```

## Состояния

- **Обычное**: Базовое состояние с полем ввода
- **Фокус**: Открывается выпадающий список с опциями
- **Загрузка**: Показывается спиннер в выпадающем списке
- **Ошибка**: Красная обводка поля ввода и текст ошибки снизу
- **Отключенное**: Компонент становится неактивным, нельзя вводить текст или выбирать опции
- **Только чтение**: Нельзя вводить текст или открывать список, но можно видеть выбранное значение
- **Пустой результат**: Показывается сообщение об отсутствии результатов
- **Создание элемента**: При включенной опции показывается возможность создания нового элемента
- **Подгрузка данных**: При прокрутке до конца списка автоматически подгружаются новые данные

## Подробное описание поведения и особенности реализации

### Режимы работы

#### 1. Режим отображения (display mode)

- Активен, когда элемент выбран и пользователь не редактирует текст
- В инпуте отображается метка выбранного элемента
- При клике на инпут открывается выпадающий список со всеми доступными элементами
- При нажатии Backspace в пустом поле происходит полная очистка выбора
- При нажатии буквы/цифры происходит переход в режим поиска, начиная с этого символа

#### 2. Режим поиска (search mode)

- Активен, когда пользователь вводит текст для поиска
- В инпуте отображается текущий поисковый запрос
- Элементы в выпадающем списке фильтруются по поисковому запросу
- При выборе элемента из списка происходит переход в режим отображения
- При нажатии Escape или клике вне компонента:
  - Если был выбран элемент, восстанавливается его полное значение
  - Если элемент не был выбран, сохраняется текущий ввод

### Клавиатурная навигация

- **↓** (Стрелка вниз): Переход к следующему элементу списка
- **↑** (Стрелка вверх): Переход к предыдущему элементу списка
- **Enter**: Выбор текущего выделенного элемента
- **Escape**: Закрытие выпадающего списка и восстановление выбранного значения
- **Backspace** (в пустом поле): Очистка выбранного значения
- **Любая буква/цифра**: Начало поиска с этого символа

### Обработка ввода и выбора

1. **Частичное редактирование выбранного значения**:

   - Когда пользователь выбрал значение и начинает его редактировать, компонент переходит в режим поиска
   - При клике вне компонента (onBlur) восстанавливается полное значение выбранного элемента
   - Это позволяет избежать ситуаций с "подвисшим" состоянием, когда значение частично отредактировано

2. **Асинхронная загрузка и пустой ввод**:
   - Когда используется `onLoadOptions` и поле ввода пустое, компонент не показывает никаких элементов
   - Это предотвращает показ нерелевантных результатов и снижает нагрузку на сервер
   - Элементы появляются только когда пользователь начинает вводить текст

### Сценарии использования

1. **Локальная фильтрация (AutocompleteBasic)**:

   - Все данные загружаются сразу и фильтруются на клиенте
   - Подходит для небольших списков (до нескольких сотен элементов)
   - Обеспечивает мгновенную обратную связь без задержек

2. **Загрузка при открытии (AutocompleteLoadOnOpen)**:

   - Данные загружаются при первом открытии компонента
   - Дальнейшая фильтрация происходит локально
   - Подходит для средних списков, когда нужно загрузить все данные один раз

3. **Асинхронная загрузка при вводе (AutocompleteWithAsyncLoading)**:

   - Данные загружаются при каждом изменении ввода (с debounce)
   - Фильтрация происходит на сервере
   - Подходит для больших списков, когда невозможно загрузить все данные сразу
   - При вводе текста с задержкой (debounce) вызывается `onLoadOptions`
   - Во время загрузки отображается спиннер
   - Текущее значение инпута сохраняется во время загрузки

4. **Создание новых элементов (AutocompleteWithCreateItem)**:
   - Позволяет добавлять новые элементы, если они не найдены в списке
   - Полезно для динамических списков, которые могут расширяться пользователем
   - Если задан `onCreateItem` и введенный текст не соответствует ни одному элементу, показывается опция для создания
   - Текст опции создания настраивается через `createItemText`

### Оптимизация производительности

1. **Debounce для ввода**:

   - Предотвращает частые запросы к серверу при быстром вводе
   - Настраивается через `debounceDelay` (по умолчанию 500 мс)

2. **Ленивая загрузка данных**:

   - При использовании `canLoadMore` и `onLoadMore` данные загружаются порциями
   - Это уменьшает начальное время загрузки и объем передаваемых данных
   - При прокрутке до конца списка автоматически вызывается `onLoadMore`

3. **Оптимизация рендеринга**:
   - Компонент использует мемоизацию для предотвращения лишних перерисовок
   - Выпадающий список рендерится только когда он открыт

### Обработка граничных случаев

1. **Пустой результат поиска**:

   - Показывается сообщение "Ничего не найдено" (настраивается через `noResultsText`)
   - При включенном `onCreateItem` предлагается создать новый элемент

2. **Потеря фокуса во время редактирования**:

   - Если был выбран элемент, восстанавливается его полное значение
   - Если элемент не был выбран, сохраняется текущий ввод

3. **Обработка ошибок загрузки**:
   - При ошибке загрузки компонент остается в рабочем состоянии
   - Рекомендуется обрабатывать ошибки в `onLoadOptions` и `onLoadMore`

### Доступность (a11y)

1. **Клавиатурная навигация**:

   - Полная поддержка навигации с клавиатуры (стрелки, Enter, Escape)
   - Выделение текущего элемента для визуальной обратной связи

2. **Состояния загрузки**:

   - Четкая индикация процесса загрузки данных
   - Сохранение контекста пользователя во время загрузки

3. **Сообщения об ошибках**:
   - Поддержка отображения сообщений об ошибках через `helperText` и `error`
   - Визуальная индикация ошибочного состояния
